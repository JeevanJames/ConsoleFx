version: 2.0.0-build.{build}
image: Visual Studio 2019 Preview
environment:
  MYGET_API_KEY:
    secure: 3tEiaoqZlTJcJkAX+3wWyp3mbCYuJpALEFzTEaum6ACiXbWgsa1kWYGBi3TUFY7c
  MYGET_FEED: https://www.myget.org/F/consolefx/api/v2/package
  CODECOV_TOKEN: 9393205e-cfa3-459f-a3d4-af5c04c3410d
  MYGET_SYMBOLS_FEED: https://www.myget.org/F/consolefx/symbols/api/v2/package
  MYGET_SYMBOLS_API_KEY:
    secure: 3tEiaoqZlTJcJkAX+3wWyp3mbCYuJpALEFzTEaum6ACiXbWgsa1kWYGBi3TUFY7c
install:
- pwsh: choco install codecov
build_script:
- pwsh: dotnet build -c Release
test_script:
- pwsh: >-
    dotnet test --blame ./test/CmdLine.Parser.Tests/CmdLine.Parser.Tests.csproj /p:CollectCoverage=true /p:Exclude=\"[xunit.*]*\" /p:CoverletOutputFormat=opencover

    codecov -f "./test/CmdLine.Parser.Tests/coverage.opencover.xml"

    dotnet test --blame ./test/ConsoleExtensions.Tests/ConsoleExtensions.Tests.csproj /p:CollectCoverage=true /p:Exclude=\"[xunit.*]*\" /p:CoverletOutputFormat=opencover

    codecov -f "./test/ConsoleExtensions.Tests/coverage.opencover.xml"
deploy_script:
- pwsh: >-
    $version = $env:APPVEYOR_BUILD_VERSION

    Write-Host $version

    Write-Host '$env:APPVEYOR_BUILD_VERSION'

    ((Get-Content -path ./metapackage/ConsoleFx.nuspec -Raw) -replace '0.0.1','$version') | Set-Content -Path ./metapackage/ConsoleFx.nuspec

    nuget pack ./metapackage/ConsoleFx.nuspec -OutputFileNamesWithoutVersion

    dotnet nuget push ./metapackage/ConsoleFx.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY


    dotnet pack ./src/CmdLine.Abstractions/CmdLine.Abstractions.csproj --include-symbols --include-source -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Abstractions/bin/Release/ConsoleFx.CmdLine.Abstractions.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY -ss $env:MYGET_SYMBOLS_FEED -sk $env:MYGET_SYMBOLS_API_KEY


    dotnet pack ./src/CmdLine.Abstractions/CmdLine.Abstractions.Sources.csproj -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Abstractions/bin/Release/ConsoleFx.CmdLine.Abstractions.Sources.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY


    dotnet pack ./src/CmdLine.Parser/CmdLine.Parser.csproj --include-symbols --include-source -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Parser/bin/Release/ConsoleFx.CmdLine.Parser.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY -ss $env:MYGET_SYMBOLS_FEED -sk $env:MYGET_SYMBOLS_API_KEY


    dotnet pack ./src/CmdLine.Parser/CmdLine.Parser.Sources.csproj -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Parser/bin/Release/ConsoleFx.CmdLine.Parser.Sources.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY


    dotnet pack ./src/CmdLine.Program/CmdLine.Program.csproj --include-symbols --include-source -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Program/bin/Release/ConsoleFx.CmdLine.Program.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY -ss $env:MYGET_SYMBOLS_FEED -sk $env:MYGET_SYMBOLS_API_KEY


    dotnet pack ./src/CmdLine.Program/CmdLine.Program.Sources.csproj -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/CmdLine.Program/bin/Release/ConsoleFx.CmdLine.Program.Sources.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY


    dotnet pack ./src/ConsoleExtensions/ConsoleExtensions.csproj --include-symbols -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/ConsoleExtensions/bin/Release/ConsoleFx.ConsoleExtensions.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY -ss $env:MYGET_SYMBOLS_FEED -sk $env:MYGET_SYMBOLS_API_KEY


    dotnet pack ./src/Prompter/Prompter.csproj --include-symbols --include-source -c Release /p:Version=$env:APPVEYOR_BUILD_VERSION

    dotnet nuget push ./src/Prompter/bin/Release/ConsoleFx.Prompter.$env:APPVEYOR_BUILD_VERSION.nupkg -s $env:MYGET_FEED -k $env:MYGET_API_KEY -ss $env:MYGET_SYMBOLS_FEED -sk $env:MYGET_SYMBOLS_API_KEY
